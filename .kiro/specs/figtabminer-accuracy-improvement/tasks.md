# FigTabMiner 识别准确率优化 - 任务列表

## 阶段 1：修复模型加载问题（P0）

- [ ] 1.1 修复 PubLayNet 权重文件路径问题
  - [ ] 1.1.1 改进 `_normalize_cached_weights()` 函数，正确处理 `?dl=1` 后缀
  - [ ] 1.1.2 添加权重文件自动重命名逻辑
  - [ ] 1.1.3 添加详细的错误日志和调试信息

- [ ] 1.2 改进错误处理机制
  - [ ] 1.2.1 添加更详细的异常捕获和日志记录
  - [ ] 1.2.2 实现优雅降级：模型加载失败时回退到基础方法
  - [ ] 1.2.3 添加模型加载状态检查函数

- [ ] 1.3 验证修复效果
  - [ ] 1.3.1 测试模型加载成功率
  - [ ] 1.3.2 验证布局检测功能正常工作
  - [ ] 1.3.3 记录测试结果和日志

## 阶段 2：集成 DocLayout-YOLO（P0）

- [ ] 2.1 安装和配置 DocLayout-YOLO
  - [ ] 2.1.1 添加 doclayout-yolo 到 requirements-extra.txt
  - [ ] 2.1.2 下载预训练权重文件
  - [ ] 2.1.3 配置模型路径和参数

- [ ] 2.2 实现 DocLayoutYOLODetector 类
  - [ ] 2.2.1 创建 `src/figtabminer/detectors/doclayout_detector.py`
  - [ ] 2.2.2 实现模型初始化逻辑
  - [ ] 2.2.3 实现 detect() 方法
  - [ ] 2.2.4 实现结果解析和格式转换

- [ ] 2.3 实现统一的 LayoutDetector 接口
  - [ ] 2.3.1 创建 `src/figtabminer/layout_detect_v2.py`
  - [ ] 2.3.2 实现 LayoutDetector 类，支持多种检测器
  - [ ] 2.3.3 实现自动降级机制（DocLayout-YOLO -> Surya -> PubLayNet）
  - [ ] 2.3.4 添加检测器能力探测函数

- [ ] 2.4 集成到主流程
  - [ ] 2.4.1 修改 figure_extract.py 使用新的 LayoutDetector
  - [ ] 2.4.2 修改 table_extract.py 使用新的 LayoutDetector
  - [ ] 2.4.3 更新 capabilities 检测逻辑

- [ ] 2.5 测试 DocLayout-YOLO 效果
  - [ ] 2.5.1 在样本 PDF 上测试检测效果
  - [ ] 2.5.2 对比新旧方法的检测结果
  - [ ] 2.5.3 调优置信度阈值和 IoU 阈值

## 阶段 3：实现智能边界框合并（P0）

- [ ] 3.1 实现基础边界框工具函数
  - [ ] 3.1.1 创建 `src/figtabminer/bbox_utils.py`
  - [ ] 3.1.2 实现 bbox_iou, bbox_overlap_ratio, bbox_distance 等函数
  - [ ] 3.1.3 实现 bbox_alignment, bbox_contains 等函数
  - [ ] 3.1.4 添加单元测试

- [ ] 3.2 实现语义合并策略
  - [ ] 3.2.1 创建 `src/figtabminer/bbox_merger.py`
  - [ ] 3.2.2 实现 SmartBBoxMerger 类
  - [ ] 3.2.3 实现 `_merge_by_caption()` 方法
  - [ ] 3.2.4 实现子图编号识别逻辑
  - [ ] 3.2.5 实现 caption 共享判断逻辑

- [ ] 3.3 实现视觉合并策略
  - [ ] 3.3.1 实现 `_merge_by_visual()` 方法
  - [ ] 3.3.2 实现连接线检测算法
  - [ ] 3.3.3 实现连通图构建和连通分量查找
  - [ ] 3.3.4 实现合并验证逻辑

- [ ] 3.4 实现噪声过滤
  - [ ] 3.4.1 实现 `_filter_noise()` 方法
  - [ ] 3.4.2 实现 `_is_arrow()` 箭头检测函数
  - [ ] 3.4.3 实现 `_is_noise()` 通用噪声检测函数
  - [ ] 3.4.4 添加可配置的过滤阈值

- [ ] 3.5 集成到提取流程
  - [ ] 3.5.1 修改 figure_extract.py 使用 SmartBBoxMerger
  - [ ] 3.5.2 修改 table_extract.py 使用 SmartBBoxMerger
  - [ ] 3.5.3 添加合并策略的配置选项

- [ ] 3.6 测试合并效果
  - [ ] 3.6.1 测试箭头过滤效果
  - [ ] 3.6.2 测试子图合并效果
  - [ ] 3.6.3 测试过度分割和错误合并率
  - [ ] 3.6.4 调优合并参数

## 阶段 4：增强表格识别（P1）

- [ ] 4.1 集成 Table Transformer
  - [ ] 4.1.1 添加 transformers 和相关依赖到 requirements-extra.txt
  - [ ] 4.1.2 创建 `src/figtabminer/detectors/table_transformer_detector.py`
  - [ ] 4.1.3 实现表格检测模型加载
  - [ ] 4.1.4 实现表格结构识别模型加载
  - [ ] 4.1.5 实现检测和识别流程

- [ ] 4.2 实现多策略融合
  - [ ] 4.2.1 创建 `src/figtabminer/table_extract_v2.py`
  - [ ] 4.2.2 实现 TableExtractor 类
  - [ ] 4.2.3 实现多策略提取逻辑（布局检测 + Table Transformer + pdfplumber）
  - [ ] 4.2.4 实现表格去重逻辑

- [ ] 4.3 优化表格内容提取
  - [ ] 4.3.1 改进 pdfplumber 表格提取参数
  - [ ] 4.3.2 实现无边框表格识别增强
  - [ ] 4.3.3 实现跨栏表格处理

- [ ] 4.4 集成到主流程
  - [ ] 4.4.1 修改 scripts/run_pipeline.py 使用新的表格提取器
  - [ ] 4.4.2 更新 capabilities 检测逻辑
  - [ ] 4.4.3 添加表格提取策略配置选项

- [ ] 4.5 测试表格识别效果
  - [ ] 4.5.1 测试有边框表格识别
  - [ ] 4.5.2 测试无边框表格识别
  - [ ] 4.5.3 测试跨栏表格识别
  - [ ] 4.5.4 计算表格检测 F1-score

## 阶段 5：优化 Caption 关联（P1）

- [ ] 5.1 改进 caption 查找算法
  - [ ] 5.1.1 修改 `src/figtabminer/caption_align.py`
  - [ ] 5.1.2 实现方向优先级逻辑（优先查找下方）
  - [ ] 5.1.3 实现编号匹配逻辑（Figure 1 对应第一个图）
  - [ ] 5.1.4 改进距离计算方法

- [ ] 5.2 实现子图编号识别
  - [ ] 5.2.1 实现 `_extract_subfigure_label()` 函数
  - [ ] 5.2.2 支持 (a), (b), (c) 格式
  - [ ] 5.2.3 支持 a), b), c) 格式
  - [ ] 5.2.4 支持其他常见格式

- [ ] 5.3 改进多行 caption 处理
  - [ ] 5.3.1 实现 caption 行连续性判断
  - [ ] 5.3.2 实现多行 caption 合并
  - [ ] 5.3.3 处理跨栏 caption

- [ ] 5.4 测试 caption 关联效果
  - [ ] 5.4.1 测试 caption 匹配准确率
  - [ ] 5.4.2 测试子图编号识别准确率
  - [ ] 5.4.3 测试多行 caption 处理效果

## 阶段 6：添加质量评估（P1）

- [ ] 6.1 实现质量评估器
  - [ ] 6.1.1 创建 `src/figtabminer/quality_assess.py`
  - [ ] 6.1.2 实现 QualityAssessor 类
  - [ ] 6.1.3 实现检测置信度评估
  - [ ] 6.1.4 实现内容完整性评估
  - [ ] 6.1.5 实现 caption 匹配度评估
  - [ ] 6.1.6 实现尺寸合理性评估
  - [ ] 6.1.7 实现位置合理性评估

- [ ] 6.2 实现综合评分逻辑
  - [ ] 6.2.1 实现加权评分算法
  - [ ] 6.2.2 添加可配置的权重参数
  - [ ] 6.2.3 实现评分详情记录

- [ ] 6.3 实现质量过滤
  - [ ] 6.3.1 实现 `filter_low_quality()` 方法
  - [ ] 6.3.2 添加可配置的质量阈值
  - [ ] 6.3.3 添加过滤日志记录

- [ ] 6.4 集成到提取流程
  - [ ] 6.4.1 在 figure_extract.py 中添加质量评估
  - [ ] 6.4.2 在 table_extract.py 中添加质量评估
  - [ ] 6.4.3 在 manifest.json 中记录质量分数

- [ ] 6.5 测试质量评估效果
  - [ ] 6.5.1 验证质量分数的合理性
  - [ ] 6.5.2 测试过滤效果
  - [ ] 6.5.3 调优质量阈值

## 阶段 7：配置和文档（P1）

- [ ] 7.1 更新配置文件
  - [ ] 7.1.1 在 config/figtabminer.json 中添加新配置项
  - [ ] 7.1.2 更新 src/figtabminer/config.py 读取新配置
  - [ ] 7.1.3 添加配置验证逻辑
  - [ ] 7.1.4 提供配置示例文件

- [ ] 7.2 更新用户文档
  - [ ] 7.2.1 更新 README.md，说明新功能和改进
  - [ ] 7.2.2 更新安装文档，说明新依赖安装方法
  - [ ] 7.2.3 添加配置文档，说明所有配置项
  - [ ] 7.2.4 添加故障排除文档

- [ ] 7.3 更新开发文档
  - [ ] 7.3.1 更新 docs/design.md
  - [ ] 7.3.2 添加架构图和流程图
  - [ ] 7.3.3 添加 API 文档

- [ ] 7.4 添加示例和教程
  - [ ] 7.4.1 添加配置示例
  - [ ] 7.4.2 添加使用教程
  - [ ] 7.4.3 添加调优指南

## 阶段 8：测试和调优（P1）

- [ ] 8.1 端到端测试
  - [ ] 8.1.1 在所有样本 PDF 上运行完整流程
  - [ ] 8.1.2 验证输出格式正确性
  - [ ] 8.1.3 验证所有功能正常工作

- [ ] 8.2 准确率测试
  - [ ] 8.2.1 计算图表检测 F1-score
  - [ ] 8.2.2 计算表格检测 F1-score
  - [ ] 8.2.3 计算边界框平均 IoU
  - [ ] 8.2.4 计算过度分割率和错误合并率

- [ ] 8.3 性能测试
  - [ ] 8.3.1 测试单页处理时间
  - [ ] 8.3.2 测试内存占用
  - [ ] 8.3.3 测试 GPU 利用率
  - [ ] 8.3.4 识别性能瓶颈

- [ ] 8.4 参数调优
  - [ ] 8.4.1 调优检测置信度阈值
  - [ ] 8.4.2 调优合并策略参数
  - [ ] 8.4.3 调优质量评估权重
  - [ ] 8.4.4 调优过滤阈值

- [ ] 8.5 回归测试
  - [ ] 8.5.1 验证新版本不降低原有功能准确率
  - [ ] 8.5.2 验证输出格式向后兼容
  - [ ] 8.5.3 验证降级机制正常工作

- [ ] 8.6 修复发现的问题
  - [ ] 8.6.1 记录测试中发现的所有问题
  - [ ] 8.6.2 按优先级修复问题
  - [ ] 8.6.3 重新测试验证修复效果

## 阶段 9：可选增强（P2）

- [ ]* 9.1 集成 Surya Layout 作为备选方案
  - [ ]* 9.1.1 添加 surya 依赖
  - [ ]* 9.1.2 实现 SuryaDetector 类
  - [ ]* 9.1.3 集成到降级链

- [ ]* 9.2 添加可视化调试工具
  - [ ]* 9.2.1 实现检测结果可视化
  - [ ]* 9.2.2 实现合并过程可视化
  - [ ]* 9.2.3 实现质量评分可视化

- [ ]* 9.3 性能优化
  - [ ]* 9.3.1 实现结果缓存
  - [ ]* 9.3.2 实现批处理
  - [ ]* 9.3.3 实现多进程并行处理

- [ ]* 9.4 添加更多指标统计
  - [ ]* 9.4.1 统计检测数量分布
  - [ ]* 9.4.2 统计合并次数分布
  - [ ]* 9.4.3 统计质量分数分布
  - [ ]* 9.4.4 生成统计报告

## 验收标准

### 功能验收
- [ ] 模型加载成功率 100%
- [ ] 支持 DocLayout-YOLO 检测
- [ ] 支持智能边界框合并
- [ ] 支持箭头过滤
- [ ] 支持增强表格识别
- [ ] 支持质量评估和过滤

### 性能验收
- [ ] 图表检测 F1-score > 0.90
- [ ] 表格检测 F1-score > 0.85
- [ ] 边界框平均 IoU > 0.85
- [ ] 过度分割率 < 5%
- [ ] 错误合并率 < 5%
- [ ] 单页处理时间 < 10 秒（GPU）

### 稳定性验收
- [ ] 无未处理异常导致崩溃
- [ ] 降级机制正常工作
- [ ] 错误信息清晰可理解

### 可用性验收
- [ ] 用户输入保持简单（单个 PDF）
- [ ] 输出格式保持兼容
- [ ] 配置文件易于理解和修改
