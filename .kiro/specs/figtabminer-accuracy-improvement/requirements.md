# FigTabMiner 识别准确率优化改进

## 1. 项目背景

### 1.1 当前问题
FigTabMiner 项目已经可以运行，但存在严重的识别准确率问题：

- **图表识别错误率高**：经常将多个图表识别为一个，或将一个图表拆分成多个
- **表格识别遗漏**：很多表格无法被识别
- **边界框不精确**：识别的图表范围不准确
- **箭头过度分割**：箭头等连接元素被单独识别成独立图表
- **模型加载错误**：布局检测模型权重文件路径问题导致初始化失败

### 1.2 技术栈
- 运行环境：Ubuntu with GPU
- 当前使用：PyMuPDF, pdfplumber, OpenCV, layoutparser + detectron2
- 可接受：引入更优秀的重量级库（只要输入输出配置简单，无需过多配置时间即可（剩余开发时长已不足36h））

## 2. 用户故事

### 2.1 作为科研人员
**我想要**准确提取 PDF 论文中的所有图表和表格  
**以便**获得高质量的结构化数据用于后续分析  
**验收标准**：
- 图表识别准确率 > 90%
- 表格识别召回率 > 85%
- 边界框 IoU > 0.85
- 不会将单个图表拆分成多个部分
- 不会将多个独立图表合并为一个

### 2.2 作为系统用户
**我想要**系统能够正确处理复杂的科学论文布局  
**以便**处理包含多子图、箭头、标注的复杂图表  
**验收标准**：
- 正确识别包含多个子图的组合图表（作为一个整体）
- 正确处理带箭头和标注的流程图
- 正确区分相邻但独立的图表
- 正确识别跨栏表格

### 2.3 作为开发者
**我想要**系统能够稳定运行不出错  
**以便**用户可以顺利使用系统  
**验收标准**：
- 模型权重文件能够正确加载
- 依赖库初始化不会失败
- 错误能够被优雅处理并降级

## 3. 功能需求

### 3.1 改进布局检测模型
**优先级**：高

**需求描述**：
- 替换或增强当前的 PubLayNet 模型
- 使用更适合科学论文的预训练模型
- 提高图表和表格的检测准确率

**可选方案**：
1. 使用 DocLayout-YOLO（专门针对文档布局）
2. 使用 YOLOv8/YOLOv9 + 自定义训练
3. 使用 LayoutLMv3 或 DiT（Document Image Transformer）
4. 使用 PaddleOCR 的版面分析模块
5. 使用 Surya 布局检测模型

### 3.2 优化图表边界检测
**优先级**：高

**需求描述**：
- 改进边界框精确度
- 减少过度分割（特别是箭头问题）
- 减少错误合并

**技术方案**：
- 实现更智能的边界框合并策略
- 使用连通域分析辅助判断
- 引入语义理解（caption 关联）
- 实现后处理过滤规则

### 3.3 增强表格识别能力
**优先级**：高

**需求描述**：
- 提高表格识别召回率
- 支持无边框表格识别
- 支持跨栏表格识别

**技术方案**：
- 集成 Table Transformer 模型
- 使用 PaddleOCR 表格识别
- 改进 pdfplumber 表格提取参数
- 实现多策略融合

### 3.4 修复模型加载问题
**优先级**：高

**需求描述**：
- 解决权重文件路径中 `?dl=1` 导致的加载失败
- 确保模型能够稳定初始化
- 提供清晰的错误提示

### 3.5 实现智能分割判断
**优先级**：中

**需求描述**：
- 判断多个检测框是否属于同一个图表
- 判断是否应该合并相邻的检测框
- 基于视觉特征和语义信息

**技术方案**：
- 分析检测框之间的空间关系
- 检查是否共享同一个 caption
- 分析视觉连续性（颜色、纹理）
- 使用启发式规则（箭头、连接线）

### 3.6 添加质量评估和过滤
**优先级**：中

**需求描述**：
- 评估每个检测结果的质量
- 过滤低质量检测
- 提供置信度分数

**技术方案**：
- 计算检测置信度
- 检查内容完整性
- 验证与 caption 的对应关系
- 实现质量阈值过滤

## 4. 非功能需求

### 4.1 性能要求
- 单页处理时间 < 10 秒（GPU 环境）
- 内存占用 < 8GB
- 支持批量处理

### 4.2 兼容性要求
- 保持现有的输入输出接口
- 向后兼容现有的配置文件
- 支持降级到轻量级模式

### 4.3 可维护性要求
- 代码结构清晰，模块化
- 关键参数可配置
- 详细的日志记录
- 完善的错误处理

## 5. 约束条件

### 5.1 技术约束
- 必须在 Ubuntu + GPU 环境运行
- 用户输入必须保持简单（只需上传 PDF）
- 输出格式必须保持一致

### 5.2 时间约束
- 优化改进应在合理时间内完成
- 不追求完美，优先解决主要问题

### 5.3 资源约束
- 可以使用重量级模型（有 GPU）
- 环境配置可以复杂，但使用必须简单

## 6. 验收标准

### 6.1 定量指标
- 图表检测 F1-score > 0.90
- 表格检测 F1-score > 0.85
- 边界框平均 IoU > 0.85
- 过度分割率 < 5%
- 错误合并率 < 5%

### 6.2 定性指标
- 能够正确处理样本 PDF 中的所有图表
- 箭头不再被单独识别
- 多子图组合被正确识别为整体
- 表格识别无明显遗漏

### 6.3 稳定性指标
- 模型加载成功率 100%
- 无未处理异常导致的崩溃
- 错误信息清晰可理解

## 7. 优先级排序

1. **P0 - 必须完成**
   - 修复模型加载错误
   - 改进布局检测模型
   - 优化边界框合并策略

2. **P1 - 应该完成**
   - 增强表格识别能力
   - 实现智能分割判断
   - 添加质量评估过滤

3. **P2 - 可以完成**
   - 性能优化
   - 参数自动调优
   - 可视化调试工具

## 8. 风险和缓解

### 8.1 风险：新模型可能不兼容现有代码
**缓解**：保持接口一致，实现适配层

### 8.2 风险：性能可能下降
**缓解**：提供轻量级和重量级两种模式

### 8.3 风险：依赖安装可能��杂
**缓解**：提供详细的安装脚本和文档

## 9. 参考资料

- DocLayout-YOLO: https://github.com/opendatalab/DocLayout-YOLO
- Table Transformer: https://github.com/microsoft/table-transformer
- PaddleOCR: https://github.com/PaddlePaddle/PaddleOCR
- Surya: https://github.com/VikParuchuri/surya
- LayoutLMv3: https://github.com/microsoft/unilm/tree/master/layoutlmv3
